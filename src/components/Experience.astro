---
// Icons
import MoreIcon from "../icons/More.astro";

// Components
import JobDetailsModal from "./JobDetailsModal.astro";

// Data
import { experienceData, type Job } from "../data/experienceData";

--- 

<div
  class="section-child flex mt-6 py-5 px-3 container-highlight"
>
  <ol class="relative ml-3 w-full">
    {
      (experienceData as Job[]).map((job, index) => (
        // Job Item
        <li class="relative flex justify-between mb-2 ms-6 gap-14">
          <div class="rounded">
            {/* Experience Timeline */}
            <div class="absolute -start-[1.475rem] top-2 bottom-0 w-px h-full
              bg-gradient-to-t from-transparent to-purple-500 dark:to-purple-500">
            </div>

            {/* Experience Timeline Dot */}
            <div class="absolute -start-[1.95rem] top-2 size-4 bg-gray-200
              rounded-full border-1 border-white dark:bg-purple-500">
            </div>

            {/* Job Icon and Position line */}
            <div class="relative flex items-center gap-3">
              {/* Job Icon */}
              <div class={`size-9 p-1 rounded-lg flex items-center justify-center 
                ${job.company.bgColorIcon} ${job.company.darkBgColorIcon}`}>
                <job.company.icon class="size-full" />

                {/* Plantilla oculta del icono para usarla en el modal */}
                <div id={`job-icon-${index}`} class="hidden">
                  <job.company.icon class="size-full" />
                </div>
              </div>

              {/* Job Position */}
              <h3 class="text-2xl font-semibold text-gray-900 dark:text-white">
                {job.position}
              </h3>
            </div>

            {/* Company Name */}
            <span class="block mt-1 mb-2 text-xl font-semibold
              leading-none text-gray-400 dark:text-purple-400 ml-12">
              {job.company.name}
            </span>

            {/* Company Description */}
            <p class="mb-4 text-base font-normal text-gray-500
            dark:text-purple-200 text-pretty ml-12 -mt-1.5">
              {job.company.description}
            </p>
          </div>

          <div class="flex flex-col pt-1 flex-1 w-full">
            <div class="flex justify-end">
              {/* Date Tag */}
              <span class="flex justify-end bg-blue-100 text-blue-800 text-sm font-medium
                px-2.5 py-0.5 rounded dark:bg-dark-purple dark:text-purple-200 shadow">
                {job.date.start + ' — ' + job.date.end}
              </span>
            </div>

            {/* Job Description */}
            <p class="mb-2 text-base font-normal text-gray-400
            dark:text-gray-300 text-pretty pt-2">
              {job.description}
            </p>
            <button 
              class="open-job-modal-trigger w-fit flex p-1 -ml-1 dark:text-purple-400
              hover:dark:text-purple-300 transition-colors"
              data-index={index}
              aria-label={`Saber más sobre el puesto en ${job.company.name}`}
            >
              <span class="font-semibold">
                Saber más
              </span>
              <MoreIcon />
            </button>
          </div>
        </li>
      ))
    }
  </ol>    
</div>

<JobDetailsModal />

<script define:vars={{ experienceData }}>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("job-details-modal-dialog");
    if (!modal) return;

    const openModalButtons = document.querySelectorAll(".open-job-modal-trigger");
    const closeModalButton = document.getElementById("close-job-modal");

    // Modal content elements
    const modalTitle = document.getElementById("modal-title");
    const modalIconContainer = document.getElementById("modal-icon-container");
    const modalItemsList = document.getElementById("modal-items-list");

    const openModal = (jobIndex) => {
      const job = experienceData[jobIndex];
      if (!job || !modalTitle || !modalIconContainer || !modalItemsList) return;

      // Complete modal details
      modalTitle.textContent = `Detalles en ${job.company.name}`;
      
      // Assign colors for icon
      modalIconContainer.className = `size-9 p-1 rounded-lg flex items-center justify-center ${job.company.bgColorIcon} ${job.company.darkBgColorIcon}`;
      
      // Get and set pre-render icon
      const iconTemplate = document.getElementById(`job-icon-${jobIndex}`);
      if (iconTemplate) {
        modalIconContainer.innerHTML = iconTemplate.innerHTML;
      } else {
        modalIconContainer.innerHTML = ''; // Clear if not found
      }

      // Complete items list
      modalItemsList.innerHTML = ''; // Clear past details
      job.items.forEach(itemText => {
        const li = document.createElement('li');
        li.textContent = itemText;
        modalItemsList.appendChild(li);
      });

      modal.showModal();
    };

    const closeModal = () => {
      modal.classList.add("closing");
      modal.addEventListener('animationend', () => {
        modal.classList.remove("closing");
        modal.close();
      }, { once: true });
    };

    openModalButtons.forEach(button => {
      button.addEventListener("click", () => {
        const jobIndex = button.dataset.index;
        openModal(jobIndex);
      });
    });

    closeModalButton?.addEventListener("click", closeModal);
    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
  });
</script>